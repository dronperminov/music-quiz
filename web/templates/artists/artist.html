{% set title = "%s | Музыкальный квиз Плюшевой наковальни" % artist.name %}
{% include "components/header.html" %}
    <link rel="stylesheet" type="text/css" href="/styles/tracks/track.css?v={{version}}">
    <link rel="stylesheet" type="text/css" href="/styles/utils/info_panels.css?v={{version}}">
    <link rel="stylesheet" type="text/css" href="/styles/utils/lyrics_updater.css?v={{version}}">
    <link rel="stylesheet" type="text/css" href="/styles/utils/player.css?v={{version}}">
    <link rel="stylesheet" type="text/css" href="/styles/artists/artist.css?v={{version}}">
</head>
<body ondragstart="return false">
    {% include "components/menu.html" %}

    <div class="content">
        <div class="artist-image">
            <img src="{{artist.image_urls[0] if artist.image_urls else '/images/artists/default.png'}}">
        </div>

        <div class="artist-name">{% if artist.source.name == "yandex" %}<a href="https://music.yandex.ru/artist/{{artist.source.yandex_id}}" target="_blank"><img src="/images/ya_music.svg"></a>{% endif %}{{artist.name}}</div>
        <div class="artist-stats">{% if artist.artist_type.to_rus() %}{{artist.artist_type.to_rus()}} | {% endif %}{% if artist.listen_count >= 1000 %}{{artist.format_listen_count()}} слушателей{% else %}{{get_word_form(artist.listen_count, ['слушатель', 'слушателя', 'слушателей'])}}{% endif %} | {{get_word_form(artist.tracks|length, ['трек', 'трека', 'треков'])}}</div>

        <div class="details">
            <div class="details-header" onclick="this.parentNode.classList.toggle('details-open')"><span class="details-icon"></span> Об исполнителе</div>
            
            <div class="details-content">
                {% if artist.description %}<div class="artist-about">{{artist.description}}</div>{% endif %}
                {% if artist.genres %}<div class="artist-about"><b>Жанры:</b> {% for genre in artist.genres %}{{ ", " if loop.index0 else "" }}{{genre.to_rus()}}{% endfor %}</div>{% endif %}
                <div class="artist-about"><b>Всего треков:</b> {{artist.tracks_count }}</div>
                <div class="artist-about"><b>Добавлен:</b> {{artist.metadata.created_at.strftime("%d.%m.%Y в %H:%M:%S")}} пользователем @{{artist.metadata.created_by }}</div>
                {% if not artist.metadata.is_initial() %}<div class="artist-about"><b>Обновлён:</b> {{artist.metadata.updated_at.strftime("%d.%m.%Y в %H:%M:%S")}} пользователем @{{artist.metadata.updated_by }}</div>{% endif %}
            </div>
        </div>

        <div class="artist-line"></div>

        <h3>Треки</h3>

        <div class="artist-tracks">
            {% for track in tracks %}
            <audio id="audio-{{track.track_id}}" data-track-id="{{track.track_id}}" {% if track.downloaded %}data-src="https://music.dronperminov.ru/tracks/{{track.track_id}}.mp3"{% else %}data-yandex-id="{{track.source.yandex_id}}"{% endif %} preload="metadata"></audio>

            <div class="track" id="track-{{track.track_id}}">
                <div class="track-main">
                    <div class="track-image"><img src="{{track.image_url if track.image_url else '/images/tracks/default.png'}}" loading="lazy" onclick="PlayPauseTrack('{{track.track_id}}')"></div>
                    <div>
                        <div class="track-title">{{track.title}}</div>
                        <div class="track-artists">
                            {% for artist_id in track.artists %}{{", " if loop.index0 else ""}}
                            {% if artist_id != artist.artist_id %}<a class="link" href="/artists/{{artist_id}}">{{artist2name[artist_id]}}</a>{% else %}<b>{{artist2name[artist_id]}}</b>{% endif %}{% endfor %}
                            {% if track.year > 0 %}({{track.year}}){% endif %}
                        </div>
                    </div>
                    <div class="track-controls">
                        {% if track.lyrics and track.lyrics.lrc %}
                        <svg id="player-{{track.track_id}}-lyrics" width="1.25em" height="1.25em" viewBox="2 2 52 52" xmlns="http://www.w3.org/2000/svg" onclick="document.getElementById('lyrics-updater-{{track.track_id}}').classList.toggle('hidden'); this.classList.toggle('player-showed-lyrics')">
                            <path d="M 29.7460 51.8359 C 33.2147 51.8359 38.4647 49.2344 38.4647 42.3437 L 38.4647 20.8984 C 38.4647 19.7265 38.6522 19.5156 39.7069 19.3047 L 50.8868 16.8437 C 51.7072 16.6563 52.2462 16 52.2462 15.1797 L 52.2462 6.3437 C 52.2462 5.0312 51.1912 4.1641 49.9024 4.4453 L 37.4803 7.1406 C 35.8632 7.4922 34.9960 8.3359 34.9960 9.7422 L 35.1366 35.8047 C 35.1366 36.8828 34.6444 37.5859 33.6835 37.7734 L 29.9569 38.5703 C 25.1757 39.5547 22.9491 42.0156 22.9491 45.6015 C 22.9491 49.2578 25.7850 51.8359 29.7460 51.8359 Z M 5.3476 16.3750 L 26.3007 16.3750 C 27.1913 16.3750 27.8944 15.6484 27.8944 14.7812 C 27.8944 13.9141 27.1913 13.2109 26.3007 13.2109 L 5.3476 13.2109 C 4.4803 13.2109 3.7538 13.9141 3.7538 14.7812 C 3.7538 15.6484 4.4803 16.3750 5.3476 16.3750 Z M 5.3476 24.7187 L 26.3007 24.7187 C 27.2147 24.7187 27.8944 23.9922 27.8944 23.1016 C 27.8944 22.2344 27.1913 21.5547 26.3007 21.5547 L 5.3476 21.5547 C 4.4803 21.5547 3.7538 22.2344 3.7538 23.1016 C 3.7538 23.9922 4.4569 24.7187 5.3476 24.7187 Z M 5.3476 33.0625 L 26.3007 33.0625 C 27.2147 33.0625 27.8944 32.3594 27.8944 31.4687 C 27.8944 30.6016 27.1913 29.8984 26.3007 29.8984 L 5.3476 29.8984 C 4.4803 29.8984 3.7538 30.6016 3.7538 31.4687 C 3.7538 32.3594 4.4569 33.0625 5.3476 33.0625 Z"/>
                        </svg>
                        {% endif %}

                        <div class="loader hidden" id="loader-{{track.track_id}}">
                            <img src="/images/loader.svg">
                        </div>

                        <svg id="player-{{track.track_id}}-load" id="player-{{track.track_id}}-play" onclick="PlayTrack('{{track.track_id}}')" width="1.25em" height="1.25em" viewBox="0 0 7.1 7.1" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.495,2.573 L1.501,0.142 C0.832,-0.265 0,0.25 0,1.069 L0,5.931 C0,6.751 0.832,7.264 1.501,6.858 L5.495,4.428 C6.168,4.018 6.168,2.983 5.495,2.573" />
                        </svg>

                        <svg id="player-{{track.track_id}}-play" class="hidden" width="1.25em" height="1.25em" viewBox="0 0 7.1 7.1" xmlns="http://www.w3.org/2000/svg" onclick="SetMediaSessionMetadata('{{track.track_id}}')">
                            <path d="M5.495,2.573 L1.501,0.142 C0.832,-0.265 0,0.25 0,1.069 L0,5.931 C0,6.751 0.832,7.264 1.501,6.858 L5.495,4.428 C6.168,4.018 6.168,2.983 5.495,2.573" />
                        </svg>

                        <svg id="player-{{track.track_id}}-pause" class="hidden" width="1.25em" height="1.25em" viewBox="-0.7 -0.05 8.1 8.1" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1,0 C0.448,0 0,0.448 0,1 L0,7 C0,7.552 0.448,8 1,8 C1.552,8 2,7.552 2,7 L2,1 C2,0.448 1.552,0 1,0 M6,1 L6,7 C6,7.552 5.552,8 5,8 C4.448,8 4,7.552 4,7 L4,1 C4,0.448 4.448,0 5,0 C5.552,0 6,0.448 6,1" />
                        </svg>
                    </div>
                    <div class="track-menu">
                        <div class="vertical-ham" onclick="infos.Show({{track.track_id}})">
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                    </div>
                </div>
                <div class="player" id="player-{{track.track_id}}"></div>
                <div class="error" id="error-{{track.track_id}}"></div>
                {% if track.lyrics and track.lyrics.lrc %}
                <div class="lyrics-updater lyrics-updater-disabled hidden" id="lyrics-updater-{{track.track_id}}">
                    <div class="lyrics-lines">
                        {% set indices = track.lyrics.get_chorus_indices() %}
                        {% for line in track.lyrics.lines %}
                        <div class="lyrics-line{% if loop.index0 in indices %} lyrics-line-chorus{% endif %}" data-time="{{line.time}}">{{line.text}}</div>
                        {% if indices.get(loop.index0, -1) != indices.get(loop.index, -1) %}<br>{% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="info-popup" id="info-popup"></div>

    {% for track in tracks %}
    <div class="info" id="info-{{track.track_id}}">
        <div class="close-icon" title="Закрыть"></div>

        <div class="info-image"><img src="{{track.image_url if track.image_url else '/images/tracks/default.png'}}" loading="lazy"></div>

        <div class="info-header-line">{% if track.source.name == "yandex" %}<a href="https://music.yandex.ru/track/{{track.source.yandex_id}}" target="_blank"><img src="/images/ya_music.svg"></a>{% endif %}{{track.title}}</div>
        {% if track.year > 0 %}<div class="info-line"><b>Год выхода:</b> {{track.year}}</div>{% endif %}
        {% if track.duration > 0 %}<div class="info-line"><b>Длительность:</b> {{track.format_duration()}}</div>{% endif %}

        {% if track.genres %}<div class="info-line"><b>Жанры:</b> {% for genre in track.genres %}{{ ", " if loop.index0 else "" }}{{genre.to_rus()}}{% endfor %}</div>{% endif %}
        {% if track.language.to_rus() %}<div class="info-line"><b>Язык:</b> {{track.language.to_rus()}}</div>{% endif %}
        <div class="info-line"><b>Добавлен:</b> {{track.metadata.created_at.strftime("%d.%m.%Y в %H:%M:%S")}} пользователем @{{track.metadata.created_by }}</div>
        {% if not track.metadata.is_initial() %}<div class="info-line"><b>Обновлён:</b> {{track.metadata.updated_at.strftime("%d.%m.%Y в %H:%M:%S")}} пользователем @{{track.metadata.updated_by }}</div>{% endif %}

        {% if track.lyrics %}
        <div class="details details-open">
            <div class="details-header" onclick="this.parentNode.classList.toggle('details-open')"><span class="details-icon"></span> Текст</div>
            <div class="details-content">
                <div class="track-lyrics">
                    {% set indices = track.lyrics.get_chorus_indices() %}
                    {% for line in track.lyrics.lines %}
                    <div class="track-lyrics-line{% if loop.index0 in indices %} track-lyrics-line-chorus{% endif %}">{{line.text}}</div>
                    {% if indices.get(loop.index0, -1) != indices.get(loop.index, -1) %}<br>{% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <script src="/js/utils/fetch.js?v={{version}}"></script>
    <script src="/js/utils/swipe_handler.js?v={{version}}"></script>
    <script src="/js/utils/info_panels.js?v={{version}}"></script>
    <script src="/js/utils/lyrics_updater.js?v={{version}}"></script>
    <script src="/js/utils/player.js?v={{version}}"></script>
    <script src="/js/utils/player_collection.js?v={{version}}"></script>
    <script src="/js/tracks/track.js?v={{version}}"></script>
    <script src="/js/artists/artist.js?v={{version}}"></script>
    <script>
        let infos = new InfoPanels()
        let players = new PlayerCollection()
    </script>
    {% include "components/footer.html" %}
</body>
</html>
